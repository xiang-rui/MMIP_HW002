# Progressive ROI-Aware Medical Image Compression

## Overview
This project implements a **progressive and region-of-interest (ROI) aware transform-domain codec** for medical image compression.
The codec supports:
- Progressive (coarse-to-fine) reconstruction
- ROI-aware quantization for diagnostically important regions
- Efficient entropy coding using run-length encoding and canonical Huffman coding

All experiments are conducted using **synthetic medical phantom images** generated by `phantom.py`, ensuring reproducibility and controlled evaluation.

---

## Dataset Generation
This project **solely uses synthetic phantom images** generated by `phantom.py`.  
No external medical datasets are required.

### Generate Phantom Image
```bash
python phantom.py
```

This command generates:
```
data/phantom_512.npy
```

The phantom simulates high-bit-depth medical images with distinct anatomical structures, making it suitable for evaluating progressive reconstruction and ROI-aware coding behavior.

---

## Progressive Encoding and Decoding (ROI ON)

### Encode
```bash
python encode_v3.py --input data/phantom_512.npy --output results/q10_v3.mmip --quality 10
```

### Decode (Progressive Stages)
```bash
python decode_v3.py --input results/q10_v3.mmip --output results/q10_v3_s1.npy --stages 1
python decode_v3.py --input results/q10_v3.mmip --output results/q10_v3_s2.npy --stages 2
python decode_v3.py --input results/q10_v3.mmip --output results/q10_v3_s3.npy --stages 3
```

---

## Quantitative Evaluation (Progressive Performance)
```bash
python - << 'PY'
import os, numpy as np
from metrics import rmse, psnr

x = np.load("data/phantom_512.npy")
for s in [1,2,3]:
    y = np.load(f"results/q10_v3_s{s}.npy")
    print(f"v3 stage{s} RMSE:", rmse(x,y), "PSNR:", psnr(x,y,16))

print("Raw bytes:", x.size * 2)
print("v3 bitstream bytes:", os.path.getsize("results/q10_v3.mmip"))
PY
```

---

## ROI-Aware Ablation Study (ROI OFF)

### Disable ROI-Aware Quantization
In `encode_v3.py`, add the following line **for ablation only**:
```python
q_roi = q_bg   # ROI OFF ablation
```

### Encode and Decode (ROI OFF)
```bash
python encode_v3.py --input data/phantom_512.npy --output results/q10_v3_no_roi.mmip --quality 10
python decode_v3.py --input results/q10_v3_no_roi.mmip --output results/q10_v3_no_roi_s3.npy --stages 3
```

---

## ROI-Aware Evaluation
```bash
python - << 'PY'
import os, numpy as np
from metrics import psnr
from roi_metrics import roi_psnr
from roi import roi_mask_from_phantom

x = np.load("data/phantom_512.npy")
roi = roi_mask_from_phantom(x, bone_threshold=9000)

y_on  = np.load("results/q10_v3_s3.npy")
y_off = np.load("results/q10_v3_no_roi_s3.npy")

print("ROI-ON  Global PSNR:", psnr(x,y_on,16))
print("ROI-ON  ROI PSNR   :", roi_psnr(x,y_on,roi,16))
print("ROI-OFF Global PSNR:", psnr(x,y_off,16))
print("ROI-OFF ROI PSNR   :", roi_psnr(x,y_off,roi,16))

print("ROI-ON  bytes:", os.path.getsize("results/q10_v3.mmip"))
print("ROI-OFF bytes:", os.path.getsize("results/q10_v3_no_roi.mmip"))
PY
```

---

## Visualization

### Install Dependencies
```bash
pip install matplotlib
```

### Generate Figures

#### Fig. 1: Progressive Reconstruction
```bash
python plot_progressive.py
```
Output:
```
results/fig_progressive.png
```

#### Fig. 2: ROI-Aware Comparison
```bash
python plot_roi_compare.py
```
Output:
```
results/fig_roi_compare.png
```

---

## Project Structure
```
.
├── phantom.py
├── encode_v3.py
├── decode_v3.py
├── metrics.py
├── roi.py
├── roi_metrics.py
├── plot_progressive.py
├── plot_roi_compare.py
├── data/
│   └── phantom_512.npy
└── results/
    ├── *.mmip
    ├── *.npy
    └── *.png
```

---

## Notes
- All experiments are fully reproducible.
- No real clinical data are used.
- Phantom-based evaluation allows controlled analysis of progressive and ROI-aware coding behavior.

---

## License
This project is intended for **educational and academic use**.
